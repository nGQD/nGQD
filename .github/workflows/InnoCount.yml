# =============================================================================
# HuggingFace Spaces Keep-Alive Workflow (Authenticated Version)
# =============================================================================
# 
# PURPOSE: Ping HF Spaces periodically to prevent cold starts.
#          Handles Gradio FE authentication via session cookies.
#
# SETUP:
#   1. Add this file to .github/workflows/keep-alive.yml
#   2. Set repository secrets:
#      - INNOCOUNT_FE: Your frontend URL
#      - INNOCOUNT_BE: Your backend URL
#      - INNOCOUNT_USER_0: Your FE Gradio username
#      - INNOCOUNT_PW_0: Your FE Gradio password
#      - HF_TOKEN: Your HuggingFace Token (for backend API access)
#
# =============================================================================

name: Keep HF Spaces Alive

on:
  schedule:
    - cron: '*/14 * * * *'
  workflow_dispatch:
    inputs:
      ping_frontend:
        description: 'Ping frontend space'
        required: false
        default: 'true'
        type: boolean
      ping_backend:
        description: 'Ping backend space'
        required: false
        default: 'true'
        type: boolean

env:
  FRONTEND_URL: ${{ secrets.INNOCOUNT_FE }}
  BACKEND_URL: ${{ secrets.INNOCOUNT_BE }}
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  FE_USER: ${{ secrets.INNOCOUNT_USER_0 }}
  FE_PASS: ${{ secrets.INNOCOUNT_PW_0 }}

jobs:
  ping-spaces:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Ping Frontend (Authenticated)
        if: ${{ github.event.inputs.ping_frontend != 'false' }}
        run: |
          echo "üîî Pinging frontend: $FRONTEND_URL"
          
          # 1. Login to establish session and save cookie
          echo "üîë Logging into Frontend..."
          LOGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -c cookies.txt \
            -X POST "$FRONTEND_URL/login" \
            -d "username=$FE_USER&password=$FE_PASS")
          
          if [ "$LOGIN_STATUS" != "200" ] && [ "$LOGIN_STATUS" != "302" ]; then
            echo "‚ùå Login failed with status $LOGIN_STATUS. Check credentials."
          else
            echo "‚úÖ Login successful (Status $LOGIN_STATUS)"
          fi

          # 2. Ping heartbeat using session cookie
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 60 -b cookies.txt \
            -X POST -H "Content-Type: application/json" \
            "$FRONTEND_URL/gradio_api/call/heartbeat" -d '{"data":[]}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          EVENT_ID=$(echo "$BODY" | jq -r '.event_id' 2>/dev/null || echo "$BODY" | awk -F'"' '{print $4}')

          if [ -z "$EVENT_ID" ] || [ "$EVENT_ID" = "null" ]; then
            echo "‚ö†Ô∏è Heartbeat API failed (HTTP $HTTP_CODE), trying main page fallback..."
            FALLBACK=$(curl -s -o /dev/null -w "%{http_code}" -b cookies.txt "$FRONTEND_URL/")
            if [ "$FALLBACK" = "200" ]; then
              echo "‚úÖ Frontend main page OK (Authenticated session active)"
            else
              echo "‚ùå Frontend unreachable even with auth (HTTP $FALLBACK)"
            fi
          else
            echo "‚úÖ Heartbeat OK. Event ID: $EVENT_ID"
            # Briefly stream to ensure process stays active
            curl -s -N --max-time 10 -b cookies.txt "$FRONTEND_URL/gradio_api/call/heartbeat/$EVENT_ID" > /dev/null
          fi

      - name: Ping Backend
        if: ${{ github.event.inputs.ping_backend != 'false' }}
        run: |
          echo "üîî Pinging backend: $BACKEND_URL"
          
          AUTH_HEADER=""
          if [ -n "$HF_TOKEN" ]; then AUTH_HEADER="Authorization: Bearer $HF_TOKEN"; fi

          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 120 \
            -X POST -H "Content-Type: application/json" -H "$AUTH_HEADER" \
            "$BACKEND_URL/gradio_api/call/heartbeat" -d '{"data":[]}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          EVENT_ID=$(echo "$BODY" | jq -r '.event_id' 2>/dev/null || echo "$BODY" | awk -F'"' '{print $4}')

          if [ -n "$EVENT_ID" ] && [ "$EVENT_ID" != "null" ]; then
            echo "‚úÖ Backend heartbeat OK. Event ID: $EVENT_ID"
            curl -s -N --max-time 10 -H "$AUTH_HEADER" "$BACKEND_URL/gradio_api/call/heartbeat/$EVENT_ID" > /dev/null
          else
            echo "‚ö†Ô∏è Backend API failed, trying direct ping..."
            FALLBACK=$(curl -s -o /dev/null -w "%{http_code}" -H "$AUTH_HEADER" "$BACKEND_URL/")
            echo "Backend Status: $FALLBACK"
          fi

      - name: Summary
        run: |
          echo "üèÅ Keep-alive ping complete at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
