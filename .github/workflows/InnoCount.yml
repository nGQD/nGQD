# =============================================================================
# HuggingFace Spaces Keep-Alive Workflow
# =============================================================================
# 
# PURPOSE: Ping HF Spaces heartbeat endpoints periodically to prevent cold starts.
#          HF free-tier spaces sleep after ~15 minutes of inactivity.
#          This workflow pings every 14 minutes to keep spaces warm.
#
# COST: GitHub Actions free tier includes 2,000 minutes/month.
#       This workflow uses ~3 minutes/day = ~90 minutes/month (well under limit).
#
# SETUP:
#   1. Add this file to .github/workflows/keep-alive.yml
#   2. Set repository secrets:
#      - HF_FRONTEND_URL: Your frontend space URL (e.g., https://ngqd-innocounterc.hf.space)
#      - HF_BACKEND_URL: Your backend space URL (e.g., https://ngqd-innocounterc-.hf.space)
#      - HF_TOKEN: (Optional) HuggingFace token if spaces are private
#
# =============================================================================

name: Keep HF Spaces Alive

on:
  # Run every 14 minutes (HF spaces sleep after ~15 min inactivity)
  schedule:
    - cron: '*/14 * * * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      ping_frontend:
        description: 'Ping frontend space'
        required: false
        default: 'true'
        type: boolean
      ping_backend:
        description: 'Ping backend space'
        required: false
        default: 'true'
        type: boolean

env:
  # Default URLs (override with repository secrets)
  FRONTEND_URL: ${{ secrets.INNOCOUNT_FE }}
  BACKEND_URL: ${{ secrets.INNOCOUNT_BE }}
  # Optional HF token for private spaces (set in repo secrets as HF_TOKEN)
  HF_TOKEN: ${{ secrets.HF_TOKEN }}

jobs:
  ping-spaces:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Ping Frontend Heartbeat
        if: ${{ github.event.inputs.ping_frontend != 'false' }}
        run: |
          echo "üîî Pinging frontend: $FRONTEND_URL"
          echo "HF_TOKEN present: ${HF_TOKEN:+yes}"

          # Preferred flow: Gradio call API (POST -> stream result)
          if [ -n "$HF_TOKEN" ]; then
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 60 -X POST -H "Content-Type: application/json" -H "Authorization: Bearer $HF_TOKEN" "$FRONTEND_URL/gradio_api/call/heartbeat" -d '{"data":[]}' 2>/dev/null || echo "error")
          else
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 60 -X POST -H "Content-Type: application/json" "$FRONTEND_URL/gradio_api/call/heartbeat" -d '{"data":[]}' 2>/dev/null || echo "error")
          fi

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          # Extract event_id robustly (try jq, fallback to awk)
          EVENT_ID=$(echo "$BODY" | jq -r '.event_id' 2>/dev/null || echo "$BODY" | awk -F'"' '{print $4}')

          if [ -n "$EVENT_ID" ] && [ "$EVENT_ID" != "null" ]; then
            echo "Event ID: $EVENT_ID ‚Äî streaming response (timeout 60s)..."
            if [ -n "$HF_TOKEN" ]; then
              STREAM=$(curl -s -N --max-time 60 -H "Authorization: Bearer $HF_TOKEN" "$FRONTEND_URL/gradio_api/call/heartbeat/$EVENT_ID" 2>/dev/null || echo "error")
            else
              STREAM=$(curl -s -N --max-time 60 "$FRONTEND_URL/gradio_api/call/heartbeat/$EVENT_ID" 2>/dev/null || echo "error")
            fi

            if [ "$STREAM" != "error" ] && [ -n "$STREAM" ]; then
              echo "‚úÖ Frontend heartbeat OK (event stream returned)"
              echo "$STREAM"
            else
              echo "‚ö†Ô∏è Event stream failed ‚Äî falling back to /api/heartbeat"
              # Fall through to /api/heartbeat fallback below
              HTTP_CODE=0
            fi
          else
            echo "‚ö†Ô∏è No event_id returned (HTTP $HTTP_CODE). Response body:"
            echo "$BODY"
            HTTP_CODE=0
          fi

          # Fallback to /api/heartbeat or root page
          if [ "$HTTP_CODE" != "200" ]; then
            if [ -n "$HF_TOKEN" ]; then
              RESPONSE2=$(curl -s -w "\n%{http_code}" --max-time 60 -X POST -H "Content-Type: application/json" -H "Authorization: Bearer $HF_TOKEN" "$FRONTEND_URL/api/heartbeat" -d '{"data":[]}' 2>/dev/null || echo "error")
            else
              RESPONSE2=$(curl -s -w "\n%{http_code}" --max-time 60 -X POST -H "Content-Type: application/json" "$FRONTEND_URL/api/heartbeat" -d '{"data":[]}' 2>/dev/null || echo "error")
            fi
            HTTP_CODE2=$(echo "$RESPONSE2" | tail -n1)
            BODY2=$(echo "$RESPONSE2" | sed '$d')
            if [ "$HTTP_CODE2" = "200" ]; then
              echo "‚úÖ Frontend /api/heartbeat OK (HTTP $HTTP_CODE2)"
              echo "Response: $BODY2"
            else
              echo "‚ö†Ô∏è /api/heartbeat returned $HTTP_CODE2, trying main page..."
              FALLBACK=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 "$FRONTEND_URL/" 2>/dev/null || echo "error")
              if [ "$FALLBACK" = "200" ]; then
                echo "‚úÖ Frontend main page OK (HTTP $FALLBACK)"
              else
                echo "‚ùå Frontend unreachable (HTTP $FALLBACK)"
              fi
            fi
          fi
      - name: Ping Backend Heartbeat
        if: ${{ github.event.inputs.ping_backend != 'false' }}
        run: |
          echo "üîî Pinging backend: $BACKEND_URL"
          echo "HF_TOKEN present: ${HF_TOKEN:+yes}"

          # Preferred flow: Gradio call API (POST -> stream result)
          if [ -n "$HF_TOKEN" ]; then
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 120 -X POST -H "Content-Type: application/json" -H "Authorization: Bearer $HF_TOKEN" "$BACKEND_URL/gradio_api/call/heartbeat" -d '{"data":[]}' 2>/dev/null || echo "error")
          else
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 120 -X POST -H "Content-Type: application/json" "$BACKEND_URL/gradio_api/call/heartbeat" -d '{"data":[]}' 2>/dev/null || echo "error")
          fi

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          EVENT_ID=$(echo "$BODY" | jq -r '.event_id' 2>/dev/null || echo "$BODY" | awk -F'"' '{print $4}')

          if [ -n "$EVENT_ID" ] && [ "$EVENT_ID" != "null" ]; then
            echo "Event ID: $EVENT_ID ‚Äî streaming response (timeout 120s)..."
            if [ -n "$HF_TOKEN" ]; then
              STREAM=$(curl -s -N --max-time 120 -H "Authorization: Bearer $HF_TOKEN" "$BACKEND_URL/gradio_api/call/heartbeat/$EVENT_ID" 2>/dev/null || echo "error")
            else
              STREAM=$(curl -s -N --max-time 120 "$BACKEND_URL/gradio_api/call/heartbeat/$EVENT_ID" 2>/dev/null || echo "error")
            fi

            if [ "$STREAM" != "error" ] && [ -n "$STREAM" ]; then
              echo "‚úÖ Backend heartbeat OK (event stream returned)"
              echo "$STREAM"
            else
              echo "‚ö†Ô∏è Event stream failed ‚Äî falling back to /api/heartbeat"
              HTTP_CODE=0
            fi
          else
            echo "‚ö†Ô∏è No event_id returned (HTTP $HTTP_CODE). Response body:"
            echo "$BODY"
            HTTP_CODE=0
          fi

          # Fallback to /api/heartbeat or root page
          if [ "$HTTP_CODE" != "200" ]; then
            if [ -n "$HF_TOKEN" ]; then
              RESPONSE2=$(curl -s -w "\n%{http_code}" --max-time 120 -X POST -H "Content-Type: application/json" -H "Authorization: Bearer $HF_TOKEN" "$BACKEND_URL/api/heartbeat" -d '{"data":[]}' 2>/dev/null || echo "error")
            else
              RESPONSE2=$(curl -s -w "\n%{http_code}" --max-time 120 -X POST -H "Content-Type: application/json" "$BACKEND_URL/api/heartbeat" -d '{"data":[]}' 2>/dev/null || echo "error")
            fi
            HTTP_CODE2=$(echo "$RESPONSE2" | tail -n1)
            BODY2=$(echo "$RESPONSE2" | sed '$d')
            if [ "$HTTP_CODE2" = "200" ]; then
              echo "‚úÖ Backend /api/heartbeat OK (HTTP $HTTP_CODE2)"
              echo "Response: $BODY2"
            else
              echo "‚ö†Ô∏è /api/heartbeat returned $HTTP_CODE2, trying main page..."
              FALLBACK=$(curl -s -o /dev/null -w "%{http_code}" --max-time 120 "$BACKEND_URL/" 2>/dev/null || echo "error")
              if [ "$FALLBACK" = "200" ]; then
                echo "‚úÖ Backend main page OK (HTTP $FALLBACK) - may have triggered cold start"
              else
                echo "‚ùå Backend unreachable (HTTP $FALLBACK)"
              fi
            fi
          fi
      - name: Summary
        run: |
          echo "üèÅ Keep-alive ping complete at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "‚ÑπÔ∏è  If spaces were sleeping, they should now be warming up."
          echo "    Cold start typically takes 30-60 seconds for frontend,"
          echo "    and 60-120 seconds for backend (model loading)."
